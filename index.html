<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checklister Varm ende ‚Äî Trimmed MVP</title>
  <style>
    :root{
      --rock-red:#E60028;
      --green:#28a745;
      --bg:#f5f5f5;
      --card:#fff;
      --text:#111;
      --muted:#666;
      --heading-bg:#E8EAF6;
      --heading-color:#1A237E;
      --note-bg:#FFFDE7;
      --note-color:#757575;
    }

    /* Dark mode tema */
    body.dark{
      --bg:#111827;
      --card:#1f2933;
      --text:#f9fafb;
      --muted:#9ca3af;
      --heading-bg:#111827;
      --heading-color:#e5e7eb;
      --note-bg:#111827;
      --note-color:#d1d5db;
    }
    body.dark header{
      background:#000;
    }
    body.dark .card{
      box-shadow:0 1px 4px rgba(0,0,0,.7);
    }
    body.dark input,
    body.dark select,
    body.dark textarea{
      background:#111827;
      border-color:#374151;
      color:#f9fafb;
    }
    body.dark .item{
      border-bottom:1px solid #374151;
    }
    body.dark .progress-track{
      background:#111827;
    }
    body.dark #progressWrapper{
      background:rgba(17,24,39,0.96);
      border-bottom:1px solid #374151;
    }
    body.dark .progress-text{
      color:#e5e7eb;
    }
    body.dark .modal-card{
      background:#111827;
      color:#f9fafb;
    }
    body.dark .modal{
      background:rgba(0,0,0,0.8);
    }

    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:var(--rock-red);
      color:#fff;
      padding:14px;
      position:sticky;
      top:0;
      z-index:1000;
    }
    header h1{margin:0;font-size:22px;line-height:1;}

    #progressWrapper{
      position:fixed;
      left:0;
      right:0;
      top:50px;
      display:none;
      align-items:center;
      justify-content:center;
      padding:4px 12px 6px;
      z-index:1200;
      background:rgba(255,255,255,0.95);
      border-bottom:1px solid #eee;
      flex-direction:column;
      gap:4px;
    }
    .progress-track{
      width:70%;
      max-width:700px;
      height:12px;
      background:#eee;
      border-radius:10px;
      overflow:hidden;
      position:relative;
    }
    .progress-fill{
      height:100%;
      width:0;
      background:var(--rock-red);
      transition:width .3s ease,background-color .3s ease;
    }
    .progress-row{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      max-width:900px;
    }
    .progress-text{
      font-weight:600;
      font-size:11px;
      color:#333;
      white-space:nowrap;
    }
    #progressHint{
      font-size:11px;
      color:#555;
    }
    body.dark #progressHint{
      color:#d1d5db;
    }

    main{max-width:900px;margin:12px auto;padding:18px}
    .card{background:var(--card);border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    label{font-weight:700}
    input,select,textarea{
      width:100%;
      padding:10px;
      border:1px solid #ddd;
      border-radius:8px;
      margin-top:8px;
      font:inherit;
    }
    textarea{min-height:100px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:160px}

    #page-home .row:last-child .col:last-child{
      min-width:100%;
      flex:1 1 100%;
      display:flex;
      align-items:flex-end;
    }
    #page-home #btnStart{width:100%}

    button{
      background:var(--rock-red);
      color:#fff;
      border:0;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
    }
    button.ghost{
      background:#fff;
      color:var(--rock-red);
      border:1px solid var(--rock-red);
    }
    .small{font-size:13px;color:var(--muted)}

    .list-items{margin-top:12px}
    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 8px;
      border-bottom:1px solid #f0f0f0;
    }
    .item label{
      flex:1;
      line-height:1.4;
      padding-top:1px;
    }
    input[type="checkbox"]{
      width:22px;
      height:22px;
      transform:scale(1.1);
      flex-shrink:0;
      margin-top:2px;
    }
    .done{
      opacity:.55;
      color:var(--muted);
    }
    .item.task.done label{text-decoration:line-through;}

    .item.heading{
      background:var(--heading-bg);
      border-left:5px solid var(--heading-color);
      margin-top:15px;
      margin-bottom:5px;
      padding:10px;
      border-bottom:none;
    }
    .item.heading label{
      font-weight:700;
      color:var(--heading-color);
      font-size:1.05em;
    }
    .item.heading input[type="checkbox"]{display:none;}

    .item.note{
      background:var(--note-bg);
      border-left:5px solid #FFC107;
      padding:8px 10px;
      font-style:italic;
      margin-top:5px;
      margin-bottom:5px;
      border-bottom:none;
    }
    .item.note label{
      color:var(--note-color);
      font-size:0.95em;
    }
    .item.note input[type="checkbox"]{display:none;}

    .list-items .item:last-child{border-bottom:none}
    .list-items .item.task + .item.heading,
    .list-items .item.task + .item.note{border-bottom:none}

    details#completedSection{margin-top:12px;border-top:1px dashed #eee;padding-top:8px}
    details#completedSection summary{font-weight:700;cursor:pointer;padding:8px 6px}
    .helper{font-size:13px;color:#b12727;margin-top:6px}
    footer{color:var(--muted);text-align:center;margin:20px 0}
    .btn-small{padding:5px 8px;font-size:12px;border-radius:6px}

    .modal{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.7);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:2000;
    }
    .modal-card{
      background:var(--card);
      padding:20px;
      border-radius:8px;
      max-width:90%;
      min-width:300px;
      box-shadow:0 4px 10px rgba(0,0,0,0.3);
    }
    .modal .close-btn{
      background:none;
      border:none;
      color:var(--rock-red);
      font-weight:600;
      cursor:pointer;
      padding:5px;
    }
    .modal-actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
  </style>
</head>
<body>
  <header id="mainHeader">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h1>Checklister</h1>
      <div style="font-weight:700;font-size:18px;line-height:1;">ROCKWOOL</div>
    </div>
  </header>

  <div id="progressWrapper" aria-hidden="true">
    <div class="progress-row">
      <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div id="progressText" class="progress-text">0% ¬∑ 0/0</div>
    </div>
    <div id="progressHint" style="display:none">Du mangler 0 opgaver</div>
  </div>

  <main>
    <section id="page-home" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>
          <div style="font-weight:800">Checklister</div>
          <div class="small">V√¶lg liste, udfyld arbejdsnummer og dato.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <!-- Dark mode ikon-knap -->
          <button id="btnToggleTheme" class="ghost" style="width:44px;padding:8px 0;font-size:18px">üåô</button>
          <button id="btnOpenSettings" class="ghost">Indstillinger</button>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col">
          <label>V√¶lg liste</label>
          <select id="homeChecklistSelect"></select>
        </div>
        <div style="width:180px">
          <label>Dato</label>
          <input id="homeDate" type="date"/>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col">
          <label>Arbejdsnummer (5 cifre)</label>
          <input id="homeWorkNr" type="text" maxlength="5" placeholder="fx 01234"/>
          <div id="workHelp" class="helper" style="display:none">Arbejdsnummer skal v√¶re pr√¶cis 5 cifre (0‚Äë9).</div>
          <div id="workRequired" class="helper" style="display:none">Arbejdsnummer skal udfyldes.</div>
        </div>
        <div class="col" style="display:flex;align-items:flex-end">
          <button id="btnStart">Start</button>
        </div>
      </div>
    </section>

    <section id="page-checklist" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="chkTitle" style="font-weight:800"></div>
          <div id="chkMeta" class="small"></div>
        </div>
        <div><button id="btnBack" class="ghost">Tilbage</button></div>
      </div>

      <div id="itemsContainer" class="list-items"></div>

      <details id="completedSection" style="display:none">
        <summary id="completedSummary">Udf√∏rte opgaver (0)</summary>
        <div id="completedContainer" class="list-items"></div>
      </details>

      <div style="margin-top:12px">
        <label>Kommentar (valgfri)</label>
        <textarea id="comment"></textarea>
      </div>

      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:8px">
        <button id="btnClearAll" class="ghost btn-small">Fjern markeringer</button>
        <button id="btnSend" style="display:none;flex-grow:1;">Send</button>
      </div>

      <div class="meta small" style="margin-top:8px">Tryk Send n√•r alle punkter er afkrydset for at sende checklisten.</div>
    </section>

    <!-- Indstillinger-modal (inline display styring) -->
    <div id="modalSettings" class="modal" style="display:none" aria-hidden="true">
      <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Indstillinger</strong><div class="small">Indtast to modtager-e-mails.</div></div>
          <div><button id="btnCloseSettings" class="close-btn">Luk</button></div>
        </div>
        <div style="margin-top:10px">
          <label>Modtager 1</label><input id="rec1" type="email" placeholder="modtager1@firma.dk"/>
          <label style="margin-top:8px">Modtager 2</label><input id="rec2" type="email" placeholder="modtager2@firma.dk"/>
          <div class="modal-actions">
            <button id="btnCloseAlt" class="ghost">Luk</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <footer class="small">Enkel offline HTML‚Äëapp</footer>

  <script>
    const LS_REC1='rg_rec1', LS_REC2='rg_rec2';
    const THEME_KEY='checklister_theme';

    const headerEl=document.getElementById('mainHeader')||document.querySelector('header');
    const progressWrapper=document.getElementById('progressWrapper');
    const progressFill=document.getElementById('progressFill');
    const progressText=document.getElementById('progressText');
    const progressHint=document.getElementById('progressHint');

    const pageHome=document.getElementById('page-home');
    const pageChecklist=document.getElementById('page-checklist');
    const homeChecklistSelect=document.getElementById('homeChecklistSelect');
    const homeWorkNr=document.getElementById('homeWorkNr');
    const homeDate=document.getElementById('homeDate');
    const btnStart=document.getElementById('btnStart');
    const btnBack=document.getElementById('btnBack');
    const chkTitle=document.getElementById('chkTitle');
    const chkMeta=document.getElementById('chkMeta');
    const itemsContainer=document.getElementById('itemsContainer');
    const completedContainer=document.getElementById('completedContainer');
    const completedSection=document.getElementById('completedSection');
    const completedSummary=document.getElementById('completedSummary');
    const comment=document.getElementById('comment');
    const workHelp=document.getElementById('workHelp');
    const workRequired=document.getElementById('workRequired');
    const btnSend=document.getElementById('btnSend');
    const btnClearAll=document.getElementById('btnClearAll');

    const modalSettings=document.getElementById('modalSettings');
    const btnOpenSettings=document.getElementById('btnOpenSettings');
    const btnCloseSettings=document.getElementById('btnCloseSettings');
    const btnCloseAlt=document.getElementById('btnCloseAlt');
    const rec1=document.getElementById('rec1');
    const rec2=document.getElementById('rec2');

    const btnToggleTheme=document.getElementById('btnToggleTheme');

    const headingWhitelist = [
      "Indledende.",
      "Smeltestart",
      "F√∏r opstart runderes anl√¶gget  :",
      "Kontroller at:",
      "Ansvarlig Liniemester."
    ];

    const checklists = {
      "Aquila opstart - Spinder passer": [
        "Drej n√∏gle til Energen anl√¶gget ved kontrolrum 6 til Manuel (skal altid v√¶re manuel under drift).",
        "Gennemg√• alarmlisten.",
        "Start k√∏levandssystemet i Group mode (Cooling billede 2201) (For at kunne dette, skal alle reguleringer v√¶re i auto).",
        "Gr√∏n lys i K√∏lesystem klar kommer f√∏rst, n√•r opstart sekvensen k√∏rer.",
        "√Öben gas og ilt haner i Aquila k√∏lerummet til oxyfuel br√¶nderne og ved gas rampen uden for kontrolrummet til BU 21-23.",
        "Opstart anl√¶g: V√¶lg Group mode p√• alle sektioner p√• 2100 (Smeltebillede).",
        "V√¶lg Start af alle sektioner undtagen uld affald i 2100.",
        "Kontroller at alle bl√¶sere og ventiler st√•r i Auto i 2100.",
        "Kontroller at opstartssekvensen ‚ÄôStep 0‚Äô er gr√∏n i billede 2109. Hvis ikke v√¶lg 0 i nederste bj√¶lke.",
        "Kontroller at s√¶tpunktet for opvarmning f√∏r skorsten er sat til 130c p√• billede 2106.",
        "N√•r ‚ÄôDrift tilstand‚Äô & ‚ÄôK√∏lesystem klar‚Äô er gr√∏n i Cooling 2201 er anl√¶gget klar til opstart.",
        "Nulstil sp√¶devandst√¶llere p√• k√∏levandsoversigt 2201.",
        "Kontroller alle flow p√• k√∏levandsbilledet 2201: Venturi 60 m3/h, Top 15 m3/h, Ring 45 m3/h, Konus 70 m3/h, Bund 100 m3/h, Centralr√∏r 60 m3/h.",
        "Sekvens billede 2109: V√¶lg 'opvarmning' - Opvarmningen starter herefter automatisk.",
        "Kontroller Oxyfuel status billede 3001: Mode skal v√¶re <Br√¶nder>, Br√¶ndere status <Off>, Mainsystem <shut off>.",
        "Billede 2104: Filter - S√¶t alle sektioner i Group mode og start dem.",
        "Tjek alle startbetingelser er ok p√• sekvens billede 2109 step 5: N-gas br√¶nder, er Lufo ok. Reset evt. Lufo p√• panelet i penthouse.",
        "I step 30 skal der udluftes cykloner: Smeltecyklon og r√∏ggas purging kan ses p√• Billede 2901 Aquila on gas (Oversigt).",
        "Billede 133: Sikre signal Digital ind og output. Tjek linesaftey sikre signaler.",
        "Tjek r√∏ggas k√∏ler, er trykket ok? Ca. 6,5 bar ved kold k√∏ler og 8,5-9 bar ved varm. Efterfyld hvis n√∏dvendigt.",
        "Reset lav tryk pressostat og linesaftey for at frigive br√¶ndere.",
        "Alle sektioner p√• AQ Chargering billede 2001: V√¶lg group mode.",
        "Alle sektioner p√• AQ chargering billede 2001: V√¶lg start.",
        "AQ Chargering billede 2001: Weighing: Tryk start. Ved problemer med r√∏rb√•ndet: Reset linesafty.",
        "Det er vigtigt at f√• fylde sten i sten kassen, da der bliver suget en del falsk luft gennem. Ved problemer med r√∏rb√•ndet reset linesafty. Der kan v√¶re arbejdet p√• mixer eller r√∏rb√•nd under rensestoppet.",
        "Kontroller at fines transport er startet, og valgt til bigbag eller silo og at spj√¶ld st√•r korrekt.",
        "ACON billede: 00500 - Start tromle sektion 1. Start uldl√∏fter. Start tromlebl√¶ser. Start forspaltevalse.",
        "Start gruppen Cooling Water p√• Billede 2207: K√∏let√•rn (det starter bakkek√∏lings k√∏let√•rnet).",
        "Tjek kammer/rensed√∏re p√• filterkanal og kammer. Start kammersugerne.",
        "Start indvendig tromlerens for tjek af dyser efter skifte. Lad tromlerens k√∏re frem til opstart.",
        "Afpr√∏v at oml√∏b kan k√∏re ud og ind. Afpr√∏v at snabelbakke kan bev√¶ges i alle 4 retninger.",
        "Start spinder. Start luftringsbl√¶ser. Kontroller drift af spinder.",
        "Tjek flow til spinder k√∏ling p√• billede 1500: Spinder. Pumpen starter med spinderen.",
        "Ved oppumpning af bindemiddel fra blandetanken til buffertank 1274, skal det f√∏rste v√¶ske der kommer op, lukkes ud af bundventilen i buffertanken.",
        "Der st√•r s√• meget vand i r√∏rstrengen, at de f√∏rste produkter risikerer at blive kasseret p√• lavt gl√∏detab, hvis det ikke lukkes ud.",
        "Tjek at affaldsanl√¶g er klar og uden alarmer p√• billede 101, 102 og 103 (Linesafety area 1, 2 og 3).",
        "Tjek at Stor stangm√∏lle er klar / i drift og affald k√∏rer til r√∏rb√•nd.",
        "V√¶lg start p√• Filter fines dosering og Alu dosering sekvens billede 2136 NH3 (Ammoniak). Tjek gr√∏n prik i transport luft! Ingen gr√∏n prik = ingen flow train. Luk evt. afsp√¶rringsventilen for at komme i gang.",
        "N√•r temp TT4 n√•r 70 C t√¶ndes Oxyfuelbr√¶nder - Bu 3,1 og 3,2 i 30 sek billede 3001.",
        "Step 45: N√•r opvarmningen er fuldf√∏rt og der er 130c ved skorstenen er anl√¶gget klar til drift og spj√¶ld til skorstenen √•bner.",
        "Step 71 Start Bu 23 p√• 500 Kw. Indv√¶lg Bu23 p√• billede 2900. Tryk reset br√¶nder og start p√• melt- heating p√• billede 2900: Aquila on gas Oversigt",
        "Step 72 Start Bu 3,3 og Bu 3,4 p√• AQ Oxyfuel billede 3001 p√• 300Kw",
        "Step 90 Start Bu 21 + Bu22 p√• 500 Kw. Indv√¶lg Bu21 og Bu22 p√• billede 2900. Tryk reset br√¶nder og start p√• melt- heating p√• billede Aquila on gas billede 2900",
        "Step 100 Klar til produktion",
        "Indv√¶lg produktion p√• billede 2106 Generel oversigt",
        "Smeltestart",
        "Start DrySoTec anl√¶get p√• billede 2135.",
        "Tjek der er natriumbikarbonat i doseringsbeholderen",
        "Indv√¶lg Raw material 6 t/h",
        "Tryk Aktuelt Setpunkt",
        "Indv√¶lg Bu 3.1- 3.4 900 Kw",
        "Indv√¶lg Bu 21 +22 1500 Kw",
        "Indv√¶lg Bu 23 p√• 1800 Kw tryk aktuelt setpunkt p√• billede 2900",
        "Waste MP1 og MP2 startes p√• 1 t/h hver.",
        "Ved 850c p√• TT 9+10 bliver Bu 3.3 frigivet",
        "Ved 850C p√• TT9 +10 frigives Returuld direkte til smeltecyklonen.",
        "Indv√¶lg Returuld med 0,6 ton/h",
        "Billede 600 Bindemiddel dosering.",
        "Lav en fyldning af spinderen",
        "Tag manuel m√•ling af smeltetemperaturen, n√•r smelten l√∏ber i udl√∏bet.",
        "Juster energien (KW) ned i forhold til smelte temperaturen"
      ],
      "Opstartsliste K√¶ldermand Aquila L5":[
        "F√∏r opstart runderes anl√¶gget  :",
        "Inspicer Smeltecyklon + Cyklon 1 + Cyklon 2 for rensefolk og smede f√∏r noget startes.",
        "Luk l√•gen p√• cykloner 1 og 2",
        "Luk taphul med ler-prop og kontroller at sifonen er √•ben.",
        "Kontroller at:",
        "Tappelanser er klargjort.",
        "K√∏ling af sifon og bakker er √•bnet.",
        "Ventiler for luft og Ammoniak til ammoniak-lanse er √•bne.",
        "L√•ge til stensilo og cyklon 1+2 er lukket.",
        "Leslaw hul er rengjort.",
        "Skift dyser til indvendig tromlerens.",
        "Skift kammerk√∏lingsdyser.",
        "Spinder: se eSOP.",
        "Monter bl√¶ser√∏r p√• spinderen.",
        "K√∏r spinder i position og l√•s den i gulv.",
        "Monter stikkene p√• spinderen.",
        "Monter multi stik p√• spinder.",
        "Drej ventil SK2 K√∏lekappe ved klaver √•bnes",
        "Kontroller at tromlebl√¶ser-lanser er rene og k√∏rt p√• plads.",
        "Start procesvandspumpe (pumperum). Rens filteret",
        "Kontroller luft til bobbelr√∏r p√• Bindemiddel buffer tank er √•bnet,",
        "Tjek haner under bindemiddel-buffertanken er √•bne, efter skylning ved nedfyring.",
        "Tjek at slange fra skyl samt hane er lukket.",
        "Tjek at dr√¶n haner p√• bindemiddel streng er lukket.",
        "Dr√¶n BM filterbeholder i BM rum + skift filtre. (Se evt. eSOP)",
        "√Öben bundhanen p√• BM filter,",
        "Start pumpen ved buffer tanken i service og",
        "k√∏r indtil der kommer friskt gr√∏n bindemiddel frem ved filtret.",
        "Luk Bundhanen p√• filtret og",
        "luk ogs√• den lille udluftningsventil i toppen af filtret.",
        "Bev√¶g halv varmt klapspj√¶ld og kontroller at det k√∏rer frit.",
        "Tjek fluidicerings-luften til halv varmt klapspj√¶ld i penthouse og lufthamre er √•bent til luft p√• splashbox.",
        "Kontroller kammer/rensed√∏re p√• filterkanal og kammer er lukket korrekt.",
        "√Öben for luft til varm splashbox, ved Alu doseringsbeholder, for at undg√• ophobning.",
        "Smelte hj√¶lpes ud af udl√∏b",
        "Efter produktion start : Runder alle etager i ovnbygningen igen.",
        "Tjek klap spj√¶ldet arbejder rigtigt."
      ],
      "K√¶ldermand rundgang":[
        "Tromlerens: Kontroller at dyserne spr√∏jter korrekt, og at der ikke er uld ved udvendige dyser.",
        "Kontroller at reverseringen hen over tromlen k√∏rer korrekt.",
        "Kontroller spyddene til tromleafbl√¶sere, fjern opbygninger.",
        "Er der flow nok p√• afbl√¶serne, tr√¶k spyddene ud og kontroller dem.",
        "Fjern opbygninger omkring forspaltevalse, samt p√• skr√•plade.",
        "Kontroller at tromlerens pumper k√∏rer korrekt",
        "T√∏r ‚Äì og V√•dk√¶lder: Kontroller vandsneglen og dr√¶nristen er fri for opbygning.",
        "Kontroller at der ikke ligger √•bne vandslanger, og at der ikke er vandspild nogen steder.",
        "Kontroller at niveauet i k√¶lderbr√∏nde er normalt, og at pumperne k√∏rer normalt.",
        "I t√∏rk√¶lderen kontrolleres omr√•det ved cellesluser for recycling for ut√¶theder.",
        "Lyt efter st√∏rre vibrationer end normalt, tjek for r√∏g i hele k√¶lderen.",
        "Pumperum: Kontroller at filtre i dagtanken ikke er stoppede , og at vi ikke bruger r√•-vand i stedet for procesvand."
      ]
    };

    let currentChecklistName=null;
    let checkedMap={};

    function adjustProgressTop(){
      progressWrapper.style.top=(headerEl.offsetHeight)+'px';
    }
    window.addEventListener('resize',adjustProgressTop);

    function isHeading(text){
      const t=text.trim();
      if(!t) return false;
      if(headingWhitelist.includes(t)) return true;
      return t.endsWith('.') && t.length < 25;
    }

    function isNote(text){
      const t=text.trim();
      const infoPatterns=[
        /^\d{1,2}\/\d{1,2}/,
        /dato/i, /navn/i, /mester/i, /lagam/i, /side \d+\/\d+/i,
        /eSOP/
      ];
      return infoPatterns.some(pattern=>pattern.test(t));
    }

    function isTask(text){
      return !isHeading(text) && !isNote(text);
    }

    function getTaskCountsFromDom(){
      const cbsInMain=itemsContainer.querySelectorAll('.item.task input[type="checkbox"]');
      const cbsInCompleted=completedContainer.querySelectorAll('.item.task input[type="checkbox"]');
      const totalTasks=cbsInMain.length + cbsInCompleted.length;
      let checkedTasks=0;
      cbsInMain.forEach(cb=>{ if(cb.checked) checkedTasks++; });
      cbsInCompleted.forEach(cb=>{ if(cb.checked) checkedTasks++; });
      return { totalTasks, checkedTasks };
    }

    function updateProgressBar(){
      if(pageChecklist.style.display==='none' || !currentChecklistName){
        progressWrapper.style.display='none';
        return;
      }
      const { totalTasks, checkedTasks } = getTaskCountsFromDom();
      if(!totalTasks){
        progressWrapper.style.display='none';
        progressText.textContent='0% ¬∑ 0/0';
        progressFill.style.width='0%';
        progressHint.style.display='none';
        return;
      }
      const pct=Math.round((checkedTasks/totalTasks)*100);
      const remaining = totalTasks - checkedTasks;

      progressFill.style.width=pct+'%';
      progressFill.style.backgroundColor=pct>=100?'var(--green)':'var(--rock-red)';
      progressText.textContent=`${pct}% ¬∑ ${checkedTasks}/${totalTasks}`;

      if(remaining > 0){
        progressHint.textContent = `Du mangler ${remaining} opgave${remaining === 1 ? '' : 'r'}`;
      } else {
        progressHint.textContent = 'Alle opgaver er udf√∏rt ‚Äì klar til at sende';
      }
      progressHint.style.display='block';

      const track = progressWrapper.querySelector('.progress-track');
      if (track) track.setAttribute('aria-valuenow', String(pct));
      progressWrapper.style.display='flex';
      checkAllAndShowSend();
    }

    function checkAllAndShowSend(){
      if(pageChecklist.style.display==='none') return;
      const { totalTasks, checkedTasks } = getTaskCountsFromDom();
      btnSend.style.display=(checkedTasks===totalTasks && totalTasks>0)?'block':'none';
    }

    function renderChecklist(name){
      currentChecklistName=name;
      checkedMap={};

      chkTitle.textContent=name;
      chkMeta.textContent=`Arbejdsnummer: ${homeWorkNr.value||''} ¬∑ Dato: ${homeDate.value||''}`;
      itemsContainer.innerHTML='';
      completedContainer.innerHTML='';
      completedSection.style.display='none';
      btnSend.style.display='none';

      const items=checklists[name]||[];
      let taskIndex=0;

      items.forEach((t,i)=>{
        const div=document.createElement('div');
        const originalText=t.trim();
        let displayText=originalText;
        let is_task=isTask(originalText);

        if(is_task){
          div.className='item task';
          div.dataset.taskIndex=taskIndex;
          taskIndex++;
        } else if(isNote(originalText)){
          div.className='item note';
        } else if(isHeading(originalText)){
          div.className='item heading';
          if(displayText.endsWith('.')) displayText=displayText.slice(0,-1);
        } else {
          div.className='item task';
          div.dataset.taskIndex=taskIndex;
          is_task=true;
          taskIndex++;
        }

        div.dataset.originalIndex=i;
        const lbl=document.createElement('label');
        lbl.textContent=displayText;

        if(is_task){
          const cb=document.createElement('input');
          cb.type='checkbox';
          cb.id='cb_'+div.dataset.taskIndex;
          lbl.htmlFor=cb.id;

          cb.addEventListener('change', e=>{
            const idx=parseInt(div.dataset.taskIndex,10);
            checkedMap[idx]=!!e.target.checked;

            if(e.target.checked){
              div.classList.add('done');
              completedContainer.appendChild(div);
              completedSection.style.display='block';
            } else {
              div.classList.remove('done');
              insertInOrder(div,itemsContainer,parseInt(div.dataset.originalIndex,10));
              if(completedContainer.children.length===0){
                completedSection.style.display='none';
              }
            }
            completedSummary.textContent='Udf√∏rte opgaver ('+completedContainer.children.length+')';
            updateProgressBar();
          });

          div.appendChild(cb);
        }

        div.appendChild(lbl);
        itemsContainer.appendChild(div);
      });

      updateProgressBar();
      adjustProgressTop();
    }

    function insertInOrder(element, container, originalIndex){
      const containerItems=Array.from(container.children).filter(el=>el.dataset.originalIndex!==undefined);
      let nextElement=null;
      for(const item of containerItems){
        const itemIndex=parseInt(item.dataset.originalIndex,10);
        if(itemIndex>originalIndex){
          nextElement=item;
          break;
        }
      }
      if(nextElement){
        container.insertBefore(element,nextElement);
      } else {
        container.appendChild(element);
      }
    }

    btnClearAll.addEventListener('click',()=>{
      if(!currentChecklistName)return;
      if(!confirm('Er du sikker p√•, at du vil fjerne alle markeringer?'))return;
      const allTaskCheckboxes=document.querySelectorAll('.item.task input[type="checkbox"]');
      allTaskCheckboxes.forEach(cb=>{
        if(cb.checked){
          cb.checked=false;
          cb.dispatchEvent(new Event('change'));
        }
      });
    });

    function buildAndSend(){
      const name=currentChecklistName;
      const items=checklists[name]||[];
      const when=new Date().toLocaleString();

      let subject=`[CHECKLISTE] ${name} - ${homeWorkNr.value||'[ukendt]'} - ${when}`;
      let body=`Arbejdsnummer: ${homeWorkNr.value||''}\nTidspunkt: ${when}\nChecklistetype: ${name}\n\nPunkter:\n`;

      let taskIndex=0;
      for(let i=0;i<items.length;i++){
        const itemText=items[i];
        if(isTask(itemText)){
          const tick=checkedMap[taskIndex]?'[x]':'[ ]';
          body+=`${tick} ${itemText}\n`;
          taskIndex++;
        } else if(isHeading(itemText)){
          body+=`\n*** ${itemText.replace(/\.$/,'').toUpperCase()} ***\n`;
        } else if(isNote(itemText)){
          body+=`(${itemText})\n`;
        }
      }

      body+=`\nKommentar:\n${comment.value||''}\n\nDato: ${homeDate.value||''}\n`;
      const r1=localStorage.getItem(LS_REC1)||rec1.value||'';
      const r2=localStorage.getItem(LS_REC2)||rec2.value||'';
      const recs=[r1,r2].filter(x=>x&&x.trim());

      if(recs.length===0){
        if(!confirm('Ingen modtagere angivet. Forts√¶t uden modtagere?'))return;
      }

      window.location.href=`mailto:${recs.join(',')}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    btnSend.addEventListener('click',buildAndSend);

    // Indstillinger via inline display
    btnOpenSettings.addEventListener('click',()=>{
      loadRecipients();
      modalSettings.style.display='flex';
      modalSettings.setAttribute('aria-hidden','false');
    });
    function closeSettings(){
      saveRecipients();
      modalSettings.style.display='none';
      modalSettings.setAttribute('aria-hidden','true');
    }
    btnCloseSettings.addEventListener('click',closeSettings);
    btnCloseAlt.addEventListener('click',closeSettings);

    function saveRecipients(){
      localStorage.setItem(LS_REC1,rec1.value||'');
      localStorage.setItem(LS_REC2,rec2.value||'');
    }
    function loadRecipients(){
      rec1.value=localStorage.getItem(LS_REC1)||'';
      rec2.value=localStorage.getItem(LS_REC2)||'';
    }

    // Dark mode
    function applyTheme(theme){
      if(theme === 'dark'){
        document.body.classList.add('dark');
        if(btnToggleTheme) btnToggleTheme.textContent = '‚òÄÔ∏è';
      } else {
        document.body.classList.remove('dark');
        if(btnToggleTheme) btnToggleTheme.textContent = 'üåô';
      }
    }

    const storedTheme = localStorage.getItem(THEME_KEY) || 'light';
    applyTheme(storedTheme);

    if(btnToggleTheme){
      btnToggleTheme.addEventListener('click', () => {
        const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(newTheme);
        localStorage.setItem(THEME_KEY, newTheme);
      });
    }

    // Start og tilbage navigation
    btnStart.addEventListener('click',()=>{
      workHelp.style.display='none';
      workRequired.style.display='none';

      if(!homeWorkNr.value||homeWorkNr.value.trim()===''){
        workRequired.style.display='block';
        return;
      }
      if(!/^\d{5}$/.test(homeWorkNr.value||'')){
        workHelp.style.display='block';
        return;
      }

      renderChecklist(homeChecklistSelect.value);
      pageHome.style.display='none';
      pageChecklist.style.display='block';
      adjustProgressTop();
      updateProgressBar();
      window.scrollTo(0,0);
    });

    btnBack.addEventListener('click',()=>{
      pageChecklist.style.display='none';
      pageHome.style.display='block';
      progressWrapper.style.display='none';
      progressFill.style.width='0%';
      progressText.textContent='0% ¬∑ 0/0';
      progressHint.style.display='none';
      currentChecklistName=null;
      window.scrollTo(0,0);
    });

    homeWorkNr.addEventListener('input',()=>{
      workHelp.style.display='none';
      workRequired.style.display='none';
      homeWorkNr.value=(homeWorkNr.value||'').replace(/[^\d]/g,'').slice(0,5);
    });

    (function init(){
      try{
        const d=new Date();
        const year=d.getFullYear();
        const month=String(d.getMonth()+1).padStart(2,'0');
        const day=String(d.getDate()).padStart(2,'0');
        homeDate.value=`${year}-${month}-${day}`;

        homeChecklistSelect.innerHTML='';
        Object.keys(checklists).forEach(k=>{
          const o=document.createElement('option');
          o.value=k;
          o.textContent=k;
          homeChecklistSelect.appendChild(o);
        });

        workHelp.style.display='none';
        workRequired.style.display='none';
        adjustProgressTop();
        progressWrapper.style.display='none';
      }catch(e){
        console.error('Kritisk fejl under initialisering:',e);
      }
    })();
  </script>
</body>
</html>
