<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checklister Varm ende — ROCKWOOL</title>
  <style>
    :root{
      --rock-red:#E60028;
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111111;
      --muted:#6b7280;
      --heading-bg:#E8EAF6;
      --heading-color:#1A237E;
      --note-bg:#FFFDE7;
      --note-color:#757575;
      --minus-red:#b91c1c;
      --minus-bg:#fee2e2;
      --minus-border:#dc2626;
      --minus-green:#16a34a;
    }

    body.dark{
      --bg:#0f172a;
      --card:#1f2933;
      --text:#f9fafb;
      --muted:#9ca3af;
      --heading-bg:#0f172a;
      --heading-color:#e5e7eb;
      --note-bg:#111827;
      --note-color:#d1d5db;
    }
    body.dark header{
      background:#b3001f;
    }
    body.dark .card{
      box-shadow:0 1px 4px rgba(0,0,0,.7);
    }
    body.dark input,
    body.dark select,
    body.dark textarea{
      background:#111827;
      border-color:#374151;
      color:#f9fafb;
    }
    body.dark .item{
      border-bottom:1px solid #374151;
    }
    body.dark .progress-track{
      background:#111827;
    }
    body.dark #progressWrapper{
      background:rgba(15,23,42,0.96);
      border-bottom:1px solid #374151;
    }
    body.dark .progress-text{
      color:#e5e7eb;
    }
    body.dark .modal-card{
      background:var(--card);
      color:var(--text);
    }
    body.dark .modal{
      background:rgba(0,0,0,0.8);
    }

    html,body{
      margin:0;
      font-family:system-ui,Roboto,Arial;
      background-color:var(--bg);
      color:var(--text);
    }
    body{
      min-height:100vh;
    }
    body.dark html,
    body.dark{
      background-color:var(--bg) !important;
      color:var(--text) !important;
    }

    main{
      max-width:900px;
      margin:12px auto;
      padding:18px;
      background-color:var(--bg);
    }

    header{
      background:var(--rock-red);
      color:#fff;
      padding:14px;
      position:sticky;
      top:0;
      z-index:1000;
    }
    header h1{margin:0;font-size:22px;line-height:1;}

    #progressWrapper{
      position:fixed;
      left:0;
      right:0;
      top:50px;
      display:none;
      align-items:center;
      justify-content:center;
      padding:4px 12px 6px;
      z-index:1200;
      background:rgba(255,255,255,0.95);
      border-bottom:1px solid #e5e7eb;
      flex-direction:column;
      gap:4px;
    }

    .progress-track{
      width:70%;
      max-width:700px;
      height:12px;
      background:#e5e7eb;
      border-radius:10px;
      overflow:hidden;
      position:relative;
    }
    body.dark .progress-track{
      background:#111827;
    }

    .progress-fill{
      height:100%;
      width:0;
      background:var(--rock-red);
      transition:width .3s ease;
    }
    .progress-row{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      max-width:900px;
    }
    .progress-text{
      font-weight:600;
      font-size:11px;
      color:#374151;
      white-space:nowrap;
    }
    body.dark .progress-text{
      color:#e5e7eb;
    }
    #progressHint{
      font-size:11px;
      color:#555;
    }
    body.dark #progressHint{
      color:#d1d5db;
    }

    /* Global minus-toggle under progress */
    #minusToggleBar{
      display:none;
      align-items:center;
      justify-content:center;
      gap:8px;
      margin-top:4px;
    }
    #btnMinusMode{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--minus-border);
      background:var(--minus-bg);
      color:var(--minus-red);
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    #btnMinusMode.active{
      background:var(--minus-red);
      color:#fff;
    }
    body.dark #btnMinusMode{
      background:#7f1d1d;
      border-color:#ef4444;
      color:#fee2e2;
    }
    body.dark #btnMinusMode.active{
      background:#b91c1c;
      color:#fff;
    }
    #minusHintText{
      font-size:11px;
      color:#6b7280;
    }
    body.dark #minusHintText{
      color:#d1d5db;
    }

    .card{
      background-color:var(--card);
      border-radius:8px;
      padding:12px;
      margin-bottom:12px;
      box-shadow:0 1px 4px rgba(0,0,0,.06);
    }

    label{font-weight:700}
    input,select,textarea{
      width:100%;
      padding:10px;
      border:1px solid #d4d4d4;
      border-radius:8px;
      margin-top:8px;
      font:inherit;
      background-color:#ffffff;
      color:#111827;
    }
    textarea{min-height:100px}
    body.dark input,
    body.dark select,
    body.dark textarea{
      background-color:#111827;
      border-color:#374151;
      color:#f9fafb;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:160px}

    #page-home .row:last-child .col:last-child{
      min-width:100%;
      flex:1 1 100%;
      display:flex;
      align-items:flex-end;
    }
    #page-home #btnStart{width:100%}

    button{
      background:var(--rock-red);
      color:#fff;
      border:0;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
    }
    button.ghost{
      background:#fff;
      color:var(--rock-red);
      border:1px solid var(--rock-red);
    }
    body.dark button{
      background:#b3001f;
      color:#f9fafb;
      border-color:#b3001f;
    }
    body.dark button.ghost{
      background:transparent;
      color:#fca5a5;
      border-color:#fca5a5;
    }

    .small{font-size:13px;color:var(--muted)}

    .list-items{margin-top:12px}
    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 8px;
      border-bottom:1px solid #e5e7eb;
    }
    body.dark .item{
      border-bottom:1px solid #374151;
    }
    .item label{
      flex:1;
      line-height:1.4;
      padding-top:1px;
      transition:color .2s ease, opacity .2s ease, text-decoration-color .2s ease;
    }

    .item.task input[type="checkbox"]{
      width:20px;
      height:20px;
      margin-top:2px;
      flex-shrink:0;
      border-radius:4px;
      border:2px solid #cbd5e1;
      appearance:none;
      -webkit-appearance:none;
      background:#fff;
      position:relative;
      cursor:pointer;
      outline:none;
      transition:border-color .2s ease, background .2s ease, transform .15s ease;
    }
    body.dark .item.task input[type="checkbox"]{
      background:#111827;
      border-color:#4b5563;
    }
    .item.task input[type="checkbox"]::before{
      content:'';
      position:absolute;
      left:4px;
      top:3px;
      width:8px;
      height:12px;
      border-right:2px solid #fff;
      border-bottom:2px solid #fff;
      transform:rotate(35deg) scale(0);
      transform-origin:bottom left;
      transition:transform .2s ease-out;
    }
    .item.task input[type="checkbox"]:checked{
      background:var(--rock-red);
      border-color:var(--rock-red);
      transform:scale(1.05);
    }
    .item.task input[type="checkbox"]:checked::before{
      transform:rotate(35deg) scale(1);
    }

    .done{
      opacity:.9;
      color:var(--rock-red);
      text-decoration:line-through;
      text-decoration-color:var(--rock-red);
    }

    /* Visuel markering for minus */
    .item.task.minus-state label{
      color:var(--minus-red);
      text-decoration:underline;
    }

    .item.heading{
      background:var(--heading-bg);
      border-left:5px solid var(--heading-color);
      margin-top:15px;
      margin-bottom:5px;
      padding:10px;
      border-bottom:none;
    }
    .item.heading label{
      font-weight:700;
      color:var(--heading-color);
      font-size:1.05em;
    }

    .item.note{
      background:var(--note-bg);
      border-left:5px solid #FFC107;
      padding:8px 10px;
      font-style:italic;
      margin-top:5px;
      margin-bottom:5px;
      border-bottom:none;
    }
    .item.note label{
      color:var(--note-color);
      font-size:0.95em;
    }

    .list-items .item:last-child{border-bottom:none}

    details#completedSection{
      margin-top:12px;
      border-top:1px dashed #e5e7eb;
      padding-top:8px;
    }
    details#completedSection summary{
      font-weight:700;
      cursor:pointer;
      padding:8px 6px;
    }

    .helper{font-size:13px;color:#b12727;margin-top:6px}
    footer{color:var(--muted);text-align:center;margin:20px 0}
    .btn-small{padding:5px 8px;font-size:12px;border-radius:6px}

    .modal{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.7);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:2000;
    }
    .modal-card{
      background:var(--card);
      padding:20px;
      border-radius:8px;
      max-width:90%;
      min-width:300px;
      box-shadow:0 4px 10px rgba(0,0,0,0.3);
    }
    .modal .close-btn{
      background:none;
      border:none;
      color:var(--rock-red);
      font-weight:600;
      cursor:pointer;
      padding:5px;
    }
    body.dark .modal .close-btn{
      color:#fca5a5;
    }
    .modal-actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }

    /* Lock button farver */
    #btnToggleLock.lock-locked{
      background:#b91c1c;
      border-color:#b91c1c;
      color:#fff;
    }
    #btnToggleLock.lock-unlocked{
      background:#16a34a;
      border-color:#16a34a;
      color:#fff;
    }
    body.dark #btnToggleLock.lock-locked{
      background:#7f1d1d;
      border-color:#7f1d1d;
    }
    body.dark #btnToggleLock.lock-unlocked{
      background:#15803d;
      border-color:#15803d;
    }

    /* MOBIL-TILPASNINGER */
    @media (max-width: 480px) {
      body {
        font-size: 16px;
      }

      main {
        padding: 10px;
      }

      header {
        padding: 10px;
      }

      header h1 {
        font-size: 18px;
      }

      .small {
        font-size: 14px;
      }

      .item {
        padding: 8px 6px;
      }

      button {
        padding: 12px 14px;
        font-size: 15px;
      }

      .item.task input[type="checkbox"] {
        width: 24px;
        height: 24px;
      }
    }
  </style>
</head>
<body>
  <header id="mainHeader">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h1>Checklister</h1>
      <div style="font-weight:700;font-size:18px;line-height:1;">ROCKWOOL</div>
    </div>
  </header>

  <div id="progressWrapper" aria-hidden="true">
    <div class="progress-row">
      <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div id="progressText" class="progress-text">0% · 0/0</div>
    </div>
    <div id="progressHint" style="display:none">Du mangler 0 opgaver</div>

    <!-- Global minus-toggle -->
    <div id="minusToggleBar">
      <button id="btnMinusMode" type="button">Minus til næste opgave</button>
      <span id="minusHintText">Aktiver for at markere én opgave som minus (kræver kommentar).</span>
    </div>
  </div>

  <main>
    <section id="page-home" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div>
          <div style="font-weight:800">Checklister</div>
          <div class="small">Vælg liste, udfyld arbejdsnummer. Dato låses til i dag.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnOpenSettings" class="ghost" title="Indstillinger">⚙️</button>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col">
          <label>Vælg liste</label>
          <select id="homeChecklistSelect"></select>
        </div>
        <div style="width:180px">
          <label>Dato</label>
          <input id="homeDate" type="date" readonly/>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col">
          <label>Arbejdsnummer (5 cifre)</label>
          <input id="homeWorkNr" type="text" maxlength="5" placeholder="fx 01234"/>
          <div id="workHelp" class="helper" style="display:none">Arbejdsnummer skal være præcis 5 cifre (0‑9).</div>
          <div id="workRequired" class="helper" style="display:none">Arbejdsnummer skal udfyldes.</div>
        </div>
        <div class="col" style="display:flex;align-items:flex-end">
          <button id="btnStart">Start</button>
        </div>
      </div>
    </section>

    <section id="page-checklist" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="chkTitle" style="font-weight:800"></div>
          <div id="chkMeta" class="small"></div>
        </div>
        <div><button id="btnBack" class="ghost">Tilbage</button></div>
      </div>

      <div id="itemsContainer" class="list-items"></div>

      <details id="completedSection" style="display:none">
        <summary id="completedSummary" title="Se udførte opgaver">Udførte opgaver (0)</summary>
        <div id="completedContainer" class="list-items"></div>
      </details>

      <div style="margin-top:12px">
        <label>Kommentar (valgfri)</label>
        <textarea id="comment"></textarea>
      </div>

      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:8px">
        <button id="btnClearAll" class="ghost btn-small">Fjern markeringer</button>
        <button id="btnSend" style="display:none;flex-grow:1;">Send</button>
      </div>

      <div class="meta small" style="margin-top:8px">Tryk Send når alle punkter er afkrydset for at sende checklisten.</div>
    </section>

    <div id="modalSettings" class="modal" style="display:none" aria-hidden="true">
      <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Indstillinger</strong>
            <div class="small">Tema, modtager-e-mails og låsning.</div>
          </div>
          <div><button id="btnCloseSettings" class="close-btn">Luk</button></div>
        </div>

        <div style="margin-top:10px">
          <label for="themeSelect">Tema</label>
          <select id="themeSelect">
            <option value="light">Lys tilstand</option>
            <option value="dark">Mørk tilstand</option>
          </select>

          <div style="margin-top:12px;display:flex;align-items:center;gap:8px">
            <label style="margin:0;">Lås modtagere</label>
            <button id="btnToggleLock" class="btn-small">Lås / lås op</button>
          </div>
          <div id="lockStatus" class="small" style="margin-top:4px;color:#6b7280;"></div>

          <label style="margin-top:12px">Modtager 1</label>
          <input id="rec1" type="email" placeholder="modtager1@firma.dk"/>

          <label style="margin-top:8px">Modtager 2</label>
          <input id="rec2" type="email" placeholder="modtager2@firma.dk"/>

          <div class="modal-actions">
            <button id="btnCloseAlt" class="ghost">Luk</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <footer class="small">Enkel offline HTML‑app</footer>

  <script>
    const STORAGE_KEYS = {
      recipient1: 'rg_rec1',
      recipient2: 'rg_rec2',
      theme:      'checklister_theme',
      lockState:  'checklister_lock_state',  // 'locked' | 'unlocked'
      lockPin:    'checklister_lock_pin'     // gemt PIN (simpel)
    };

    const headerEl=document.getElementById('mainHeader')||document.querySelector('header');
    const progressWrapper=document.getElementById('progressWrapper');
    const progressFill=document.getElementById('progressFill');
    const progressText=document.getElementById('progressText');
    const progressHint=document.getElementById('progressHint');
    const progressTrack=document.querySelector('.progress-track');
    const minusToggleBar=document.getElementById('minusToggleBar');
    const btnMinusMode=document.getElementById('btnMinusMode');
    const minusHintText=document.getElementById('minusHintText');

    const pageHome=document.getElementById('page-home');
    const pageChecklist=document.getElementById('page-checklist');
    const homeChecklistSelect=document.getElementById('homeChecklistSelect');
    const homeWorkNr=document.getElementById('homeWorkNr');
    const homeDate=document.getElementById('homeDate');
    const btnStart=document.getElementById('btnStart');
    const btnBack=document.getElementById('btnBack');
    const chkTitle=document.getElementById('chkTitle');
    const chkMeta=document.getElementById('chkMeta');
    const itemsContainer=document.getElementById('itemsContainer');
    const completedContainer=document.getElementById('completedContainer');
    const completedSection=document.getElementById('completedSection');
    const completedSummary=document.getElementById('completedSummary');
    const comment=document.getElementById('comment');
    const workHelp=document.getElementById('workHelp');
    const workRequired=document.getElementById('workRequired');
    const btnSend=document.getElementById('btnSend');
    const btnClearAll=document.getElementById('btnClearAll');

    const modalSettings=document.getElementById('modalSettings');
    const btnOpenSettings=document.getElementById('btnOpenSettings');
    const btnCloseSettings=document.getElementById('btnCloseSettings');
    const btnCloseAlt=document.getElementById('btnCloseAlt');
    const rec1=document.getElementById('rec1');
    const rec2=document.getElementById('rec2');
    const themeSelect=document.getElementById('themeSelect');
    const btnToggleLock=document.getElementById('btnToggleLock');
    const lockStatus=document.getElementById('lockStatus');

    const headingWhitelist = [
      "Smeltestart",
      "Før opstart runderes anlægget  :"
    ];

    const checklists = {
      "Aquila opstart - Spinder passer": [
        "Drej nøgle til Energen anlægget ved kontrolrum 6 til Manuel (skal altid være manuel under drift).",
        "Gennemgå alarmlisten.",
        "Start kølevandssystemet i Group mode (Cooling billede 2201) (For at kunne dette, skal alle reguleringer være i auto).",
        "Grøn lys i Kølesystem klar kommer først, når opstart sekvensen kører.",
        "Åben gas og ilt haner i Aquila kølerummet til oxyfuel brænderne og ved gas rampen uden for kontrolrummet til BU 21-23.",
        "Opstart anlæg: Vælg Group mode på alle sektioner på 2100 (Smeltebillede).",
        "Vælg Start af alle sektioner undtagen uld affald i 2100.",
        "Kontroller at alle blæsere og ventiler står i Auto i 2100.",
        "Kontroller at opstartssekvensen ’Step 0’ er grøn i billede 2109. Hvis ikke vælg 0 i nederste bjælke.",
        "Kontroller at sætpunktet for opvarmning før skorsten er sat til 130c på billede 2106.",
        "Når ’Drift tilstand’ & ’Kølesystem klar’ er grøn i Cooling 2201 er anlægget klar til opstart.",
        "Nulstil spædevandstællere på kølevandsoversigt 2201.",
        "Kontroller alle flow på kølevandsbilledet 2201: Venturi 60 m3/h, Top 15 m3/h, Ring 45 m3/h, Konus 70 m3/h, Bund 100 m3/h, Centralrør 60 m3/h.",
        "Sekvens billede 2109: Vælg 'opvarmning' - Opvarmningen starter herefter automatisk.",
        "Kontroller Oxyfuel status billede 3001: Mode skal være <Brænder>, Brændere status <Off>, Mainsystem <shut off>.",
        "Billede 2104: Filter - Sæt alle sektioner i Group mode og start dem.",
        "Tjek alle startbetingelser er ok på sekvens billede 2109 step 5: N-gas brænder, er Lufo ok. Reset evt. Lufo på panelet i penthouse.",
        "I step 30 skal der udluftes cykloner: Smeltecyklon og røggas purging kan ses på Billede 2901 Aquila on gas (Oversigt).",
        "Billede 133: Sikre signal Digital ind og output. Tjek linesaftey sikre signaler.",
        "Tjek røggas køler, er trykket ok? Ca. 6,5 bar ved kold køler og 8,5-9 bar ved varm. Efterfyld hvis nødvendigt.",
        "Reset lav tryk pressostat og linesaftey for at frigive brændere.",
        "Alle sektioner på AQ Chargering billede 2001: Vælg group mode.",
        "Alle sektioner på AQ chargering billede 2001: Vælg start.",
        "AQ Chargering billede 2001: Weighing: Tryk start. Ved problemer med rørbåndet: Reset linesafty.",
        "Det er vigtigt at få fylde sten i sten kassen, da der bliver suget en del falsk luft gennem. Ved problemer med rørbåndet reset linesafty. Der kan være arbejdet på mixer eller rørbånd under rensestoppet.",
        "Kontroller at fines transport er startet, og valgt til bigbag eller silo og at spjæld står korrekt.",
        "ACON billede: 00500 - Start tromle sektion 1. Start uldløfter. Start tromleblæser. Start forspaltevalse.",
        "Start gruppen Cooling Water på Billede 2207: Køletårn (det starter bakkekølings køletårnet).",
        "Tjek kammer/rensedøre på filterkanal og kammer. Start kammersugerne.",
        "Start indvendig tromlerens for tjek af dyser efter skifte. Lad tromlerens køre frem til opstart.",
        "Afprøv at omløb kan køre ud og ind. Afprøv at snabelbakke kan bevæges i alle 4 retninger.",
        "Start spinder. Start luftringsblæser. Kontroller drift af spinder.",
        "Tjek flow til spinder køling på billede 1500: Spinder. Pumpen starter med spinderen.",
        "Ved oppumpning af bindemiddel fra blandetanken til buffertank 1274, skal det første væske der kommer op, lukkes ud af bundventilen i buffertanken.",
        "Der står så meget vand i rørstrengen, at de første produkter risikerer at blive kasseret på lavt glødetab, hvis det ikke lukkes ud.",
        "Tjek at affaldsanlæg er klar og uden alarmer på billede 101, 102 og 103 (Linesafety area 1, 2 og 3).",
        "Tjek at Stor stangmølle er klar / i drift og affald kører til rørbånd.",
        "Vælg start på Filter fines dosering og Alu dosering sekvens billede 2136 NH3 (Ammoniak). Tjek grøn prik i transport luft! Ingen grøn prik = ingen flow train. Luk evt. afspærringsventilen for at komme i gang.",
        "Når temp TT4 når 70 C tændes Oxyfuelbrænder - Bu 3,1 og 3,2 i 30 sek billede 3001.",
        "Step 45: Når opvarmningen er fuldført og der er 130c ved skorstenen er anlægget klar til drift og spjæld til skorstenen åbner.",
        "Step 71 Start Bu 23 på 500 Kw. Indvælg Bu23 på billede 2900. Tryk reset brænder og start på melt- heating på billede 2900: Aquila on gas Oversigt",
        "Step 72 Start Bu 3,3 og Bu 3,4 på AQ Oxyfuel billede 3001 på 300Kw",
        "Step 90 Start Bu 21 + Bu22 på 500 Kw. Indvælg Bu21 og Bu22 på billede 2900. Tryk reset brænder og start på melt- heating på billede Aquila on gas billede 2900",
        "Step 100 Klar til produktion",
        "Indvælg produktion på billede 2106 Generel oversigt",
        "Smeltestart",
        "Start DrySoTec anlæget på billede 2135.",
        "Tjek der er natriumbikarbonat i doseringsbeholderen",
        "Indvælg Raw material 6 t/h",
        "Tryk Aktuelt Setpunkt",
        "Indvælg Bu 3.1- 3.4 900 Kw",
        "Indvælg Bu 21 +22 1500 Kw",
        "Indvælg Bu 23 på 1800 Kw tryk aktuelt setpunkt på billede 2900",
        "Waste MP1 og MP2 startes på 1 t/h hver.",
        "Ved 850c på TT 9+10 bliver Bu 3.3 frigivet",
        "Ved 850C på TT9 +10 frigives Returuld direkte til smeltecyklonen.",
        "Indvælg Returuld med 0,6 ton/h",
        "Billede 600 Bindemiddel dosering.",
        "Lav en fyldning af spinderen",
        "Tag manuel måling af smeltetemperaturen, når smelten løber i udløbet.",
        "Juster energien (KW) ned i forhold til smelte temperaturen"
      ],
      "Opstartsliste Kældermand Aquila L5":[
        "Før opstart runderes anlægget  :",
        "Inspicer Smeltecyklon + Cyklon 1 + Cyklon 2 for rensefolk og smede før noget startes.",
        "Luk lågen på cykloner 1 og 2",
        "Luk taphul med ler-prop og kontroller at sifonen er åben.",
        "Kontroller at:",
        "Tappelanser er klargjort.",
        "Køling af sifon og bakker er åbnet.",
        "Ventiler for luft og Ammoniak til ammoniak-lanse er åbne.",
        "Låge til stensilo og cyklon 1+2 er lukket.",
        "Leslaw hul er rengjort.",
        "Skift dyser til indvendig tromlerens.",
        "Skift kammerkølingsdyser.",
        "Spinder: se eSOP.",
        "Monter blæserør på spinderen.",
        "Kør spinder i position og lås den i gulv.",
        "Monter stikkene på spinderen.",
        "Monter multi stik på spinderen.",
        "Drej ventil SK2 Kølekappe ved klaver åbnes",
        "Kontroller at tromleblæser-lanser er rene og kørt på plads.",
        "Start procesvandspumpe (pumperum). Rens filteret",
        "Kontroller luft til bobbelrør på Bindemiddel buffer tank er åbnet,",
        "Tjek haner under bindemiddel-buffertanken er åbne, efter skylning ved nedfyring.",
        "Tjek at slange fra skyl samt hane er lukket.",
        "Tjek at dræn haner på bindemiddel streng er lukket.",
        "Dræn BM filterbeholder i BM rum + skift filtre. (Se evt. eSOP)",
        "Åben bundhanen på BM filter,",
        "Start pumpen ved buffer tanken i service og",
        "kør indtil der kommer friskt grøn bindemiddel frem ved filtret.",
        "Luk Bundhanen på filtret og",
        "luk også den lille udluftningsventil i toppen af filtret.",
        "Bevæg halv varmt klapspjæld og kontroller at det kører frit.",
        "Tjek fluidicerings-luften til halv varmt klapspjæld i penthouse og lufthamre er åbent til luft på splashbox.",
        "Kontroller kammer/rensedøre på filterkanal og kammer er lukket korrekt.",
        "Åben for luft til varm splashbox, ved Alu doseringsbeholder, for at undgå ophobning.",
        "Smelte hjælpes ud af udløb",
        "Efter produktion start : Runder alle etager i ovnbygningen igen.",
        "Tjek klap spjældet arbejder rigtigt."
      ],
      "Kældermand rundgang":[
        "Tromlerens: Kontroller at dyserne sprøjter korrekt, og at der ikke er uld ved udvendige dyser.",
        "Kontroller at reverseringen hen over tromlen kører korrekt.",
        "Kontroller spyddene til tromleafblæsere, fjern opbygninger.",
        "Er der flow nok på afblæserne, træk spyddene ud og kontroller dem.",
        "Fjern opbygninger omkring forspaltevalse, samt på skråplade.",
        "Kontroller at tromlerens pumper kører korrekt",
        "Tør – og Vådkælder: Kontroller vandsneglen og drænristen er fri for opbygning.",
        "Kontroller at der ikke ligger åbne vandslanger, og at der ikke er vandspild nogen steder.",
        "Kontroller at niveauet i kælderbrønde er normalt, og at pumperne kører normalt.",
        "I tørkælderen kontrolleres området ved cellesluser for recycling for utætheder.",
        "Lyt efter større vibrationer end normalt, tjek for røg i hele kælderen.",
        "Pumperum: Kontroller at filtre i dagtanken ikke er stoppede , og at vi ikke bruger rå-vand i stedet for procesvand."
      ]
    };

    let currentChecklistName=null;
    // pr. taskIndex: { checked:boolean, minus:boolean, comment:string }
    let taskStateMap = {};
    let minusModeActive = false;

    function show(el, display='block'){
      if (!el) return;
      el.style.display = display;
    }
    function hide(el){
      if (!el) return;
      el.style.display = 'none';
    }

    function adjustProgressTop(){
      progressWrapper.style.top=(headerEl.offsetHeight)+'px';
    }
    window.addEventListener('resize',adjustProgressTop);

    function isHeading(text){
      const t=text.trim();
      if(!t) return false;
      if(headingWhitelist.includes(t)) return true;
      return t.endsWith('.') && t.length < 25;
    }

    function isNote(text){
      const t=text.trim();
      const infoPatterns=[
        /^\d{1,2}\/\d{1,2}/,
        /dato/i, /navn/i, /mester/i, /lagam/i, /side \d+\/\d+/i,
        /eSOP/
      ];
      return infoPatterns.some(pattern=>pattern.test(t));
    }

    function isTask(text){
      return !isHeading(text) && !isNote(text);
    }

    function initTaskState(idx){
      if(!taskStateMap[idx]){
        taskStateMap[idx] = { checked:false, minus:false, comment:'' };
      }
      return taskStateMap[idx];
    }

    function setTaskChecked(idx, value){
      const s = initTaskState(idx);
      s.checked = !!value;
      if (value) {
        s.minus = false;
      }
    }

    function setTaskMinus(idx, value){
      const s = initTaskState(idx);
      s.minus = !!value;
      if (value) {
        s.checked = false;
      }
    }

    function getTaskCountsFromDom(){
      const cbsInMain=itemsContainer.querySelectorAll('.item.task input[type="checkbox"]');
      const cbsInCompleted=completedContainer.querySelectorAll('.item.task input[type="checkbox"]');
      const totalTasks=cbsInMain.length + cbsInCompleted.length;
      let checkedTasks=0;
      cbsInMain.forEach(cb=>{ if(cb.checked) checkedTasks++; });
      cbsInCompleted.forEach(cb=>{ if(cb.checked) checkedTasks++; });
      return { totalTasks, checkedTasks };
    }

    function updateCompletedSummary() {
      const doneCount = completedContainer.querySelectorAll('.item.task').length;
      if (doneCount === 0) {
        hide(completedSection);
      } else {
        show(completedSection);
      }
      completedSummary.textContent = `Udførte opgaver (${doneCount})`;
    }

    function updateProgressBar(){
      if(pageChecklist.style.display==='none' || !currentChecklistName){
        hide(progressWrapper);
        return;
      }
      const { totalTasks, checkedTasks } = getTaskCountsFromDom();
      if(!totalTasks){
        hide(progressWrapper);
        progressText.textContent='0% · 0/0';
        progressFill.style.width='0%';
        hide(progressHint);
        if(progressTrack) progressTrack.setAttribute('aria-valuenow','0');
        return;
      }
      const pct=Math.round((checkedTasks/totalTasks)*100);
      const remaining = totalTasks - checkedTasks;

      progressFill.style.width=pct+'%';
      progressFill.style.backgroundColor=getComputedStyle(document.documentElement).getPropertyValue('--rock-red') || '#E60028';
      progressText.textContent=`${pct}% · ${checkedTasks}/${totalTasks}`;

      if(remaining > 0){
        progressHint.textContent = `Du mangler ${remaining} opgave${remaining === 1 ? '' : 'r'}`;
      } else {
        progressHint.textContent = 'Alle opgaver er udført – klar til at sende';
      }
      show(progressHint);

      if (progressTrack) progressTrack.setAttribute('aria-valuenow', String(pct));
      show(progressWrapper,'flex');
      show(minusToggleBar,'flex');
      checkAllAndShowSend();
    }

    function checkAllAndShowSend(){
      if(pageChecklist.style.display==='none') return;
      const { totalTasks, checkedTasks } = getTaskCountsFromDom();
      btnSend.style.display=(checkedTasks===totalTasks && totalTasks>0)?'block':'none';
    }

    function attachCheckboxLogic(cb, div){
      cb.addEventListener('change', e=>{
        const idx=parseInt(div.dataset.taskIndex,10);
        const state = initTaskState(idx);

        // Minus-mode: brug minus i stedet for flueben
        if (minusModeActive) {
          minusModeActive = false;
          btnMinusMode.classList.remove('active');
          minusHintText.textContent = 'Aktiver for at markere én opgave som minus (kræver kommentar).';

          cb.checked = false;

          const existingComment = state.comment || '';
          const commentText = prompt('Angiv kommentar til minus (påkrævet):', existingComment);
          if (!commentText || commentText.trim()==='') {
            alert('Kommentar er påkrævet for minus. Opgaven markeres ikke som minus.');
            setTaskMinus(idx,false);
            div.classList.remove('minus-state');
            updateProgressBar();
            return;
          }

          state.comment = commentText.trim();
          setTaskMinus(idx,true);
          setTaskChecked(idx,false);

          div.classList.add('minus-state');
          div.classList.remove('done');

          if (div.parentElement === completedContainer) {
            insertInOrder(div, itemsContainer, parseInt(div.dataset.originalIndex,10));
            updateCompletedSummary();
          }

          updateProgressBar();
          return;
        }

        // Normal flueben-logik
        const checked = !!e.target.checked;
        setTaskChecked(idx, checked);

        if (checked) {
          div.classList.remove('minus-state');
        }

        if(checked){
          div.classList.add('done');
          setTimeout(() => {
            completedContainer.appendChild(div);
            updateCompletedSummary();
          }, 250);
        } else {
          div.classList.remove('done');
          insertInOrder(div, itemsContainer, parseInt(div.dataset.originalIndex,10));
          updateCompletedSummary();
        }
        updateProgressBar();
      });
    }

    function renderChecklist(name){
      currentChecklistName=name;
      taskStateMap={};

      chkTitle.textContent=name;
      chkMeta.textContent=`Arbejdsnummer: ${homeWorkNr.value||''} · Dato: ${homeDate.value||''}`;
      itemsContainer.innerHTML='';
      completedContainer.innerHTML='';
      hide(completedSection);
      completedSummary.textContent='Udførte opgaver (0)';
      hide(btnSend);

      const items=checklists[name]||[];
      let taskIndex=0;

      items.forEach((t,i)=>{
        const div=document.createElement('div');
        const originalText=t.trim();
        let displayText=originalText;

        div.dataset.originalIndex=i;

        if (isNote(originalText)) {
          div.className='item note';
          const lbl=document.createElement('label');
          lbl.textContent=displayText;
          div.appendChild(lbl);
          itemsContainer.appendChild(div);
          return;
        }

        if (isHeading(originalText)) {
          div.className='item heading';
          if(displayText.endsWith('.')) displayText=displayText.slice(0,-1);
          const lbl=document.createElement('label');
          lbl.textContent=displayText;
          div.appendChild(lbl);
          itemsContainer.appendChild(div);
          return;
        }

        // Task
        div.className='item task';
        div.dataset.taskIndex=taskIndex++;

        const idx = parseInt(div.dataset.taskIndex,10);
        initTaskState(idx);

        const cb=document.createElement('input');
        cb.type='checkbox';
        cb.id='cb_'+div.dataset.taskIndex;

        const lbl=document.createElement('label');
        lbl.htmlFor=cb.id;
        lbl.textContent=displayText;

        div.appendChild(cb);
        div.appendChild(lbl);

        attachCheckboxLogic(cb, div);
        itemsContainer.appendChild(div);
      });

      updateCompletedSummary();
      updateProgressBar();
      adjustProgressTop();
    }

    function insertInOrder(element, container, originalIndex){
      const containerItems=Array.from(container.children)
        .filter(el => typeof el.dataset.originalIndex !== 'undefined');
      let nextElement=null;
      for(const item of containerItems){
        const itemIndex=parseInt(item.dataset.originalIndex,10);
        if(itemIndex>originalIndex){
          nextElement=item;
          break;
        }
      }
      if(nextElement){
        container.insertBefore(element,nextElement);
      } else {
        container.appendChild(element);
      }
    }

    btnClearAll.addEventListener('click',()=>{
      if(!currentChecklistName)return;
      if(!confirm('Er du sikker på, at du vil fjerne alle markeringer?'))return;
      const allTaskCheckboxes=document.querySelectorAll('.item.task input[type="checkbox"]');
      allTaskCheckboxes.forEach(cb=>{
        if(cb.checked){
          cb.checked=false;
          cb.dispatchEvent(new Event('change'));
        }
      });
      Object.keys(taskStateMap).forEach(k=>{
        taskStateMap[k].minus=false;
      });
      document.querySelectorAll('.item.task').forEach(div=>{
        div.classList.remove('minus-state');
      });
    });

    function buildAndSend(){
      const name=currentChecklistName;
      const items=checklists[name]||[];
      const when=new Date().toLocaleString();

      let subject=`[CHECKLISTE] ${name} - ${homeWorkNr.value||'[ukendt]'} - ${when}`;
      let body=`Arbejdsnummer: ${homeWorkNr.value||''}\nTidspunkt: ${when}\nChecklistetype: ${name}\n\nPunkter:\n`;

      let taskIndex=0;
      for(let i=0;i<items.length;i++){
        const itemText=items[i];
        if(isTask(itemText)){
          const state = taskStateMap[taskIndex] || { checked:false, minus:false, comment:'' };
          let mark;
          if (state.minus) {
            mark = '[-]';
          } else if (state.checked) {
            mark = '[x]';
          } else {
            mark = '[ ]';
          }

          body+=`${mark} ${itemText}\n`;
          if (state.minus && state.comment) {
            body+=`    Kommentar: ${state.comment}\n`;
          }
          taskIndex++;
        } else if(isHeading(itemText)){
          body+=`\n*** ${itemText.replace(/\.$/,'').toUpperCase()} ***\n`;
        } else if(isNote(itemText)){
          body+=`(${itemText})\n`;
        }
      }

      body+=`\nKommentar (generel):\n${comment.value||''}\n\nDato: ${homeDate.value||''}\n`;
      const r1=localStorage.getItem(STORAGE_KEYS.recipient1)||rec1.value||'';
      const r2=localStorage.getItem(STORAGE_KEYS.recipient2)||rec2.value||'';
      const recs=[r1,r2].filter(x=>x&&x.trim());

      if(recs.length===0){
        if(!confirm('Ingen modtagere angivet. Fortsæt uden modtagere?'))return;
      }

      window.location.href=`mailto:${recs.join(',')}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      alert('Checkliste er overført til din mailklient – husk at trykke Send.');
    }
    btnSend.addEventListener('click',buildAndSend);

    homeWorkNr.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btnStart.click();
      }
    });

    // Minus-mode toggle
    btnMinusMode.addEventListener('click', () => {
      minusModeActive = !minusModeActive;
      if (minusModeActive) {
        btnMinusMode.classList.add('active');
        minusHintText.textContent = 'Minus er aktiv: klik på én opgave for at markere minus (kræver kommentar).';
      } else {
        btnMinusMode.classList.remove('active');
        minusHintText.textContent = 'Aktiver for at markere én opgave som minus (kræver kommentar).';
      }
    });

    // Indstillinger / modal
    btnOpenSettings.addEventListener('click',()=>{
      loadRecipients();
      const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
      themeSelect.value = currentTheme;
      applyLockStateUI();
      show(modalSettings,'flex');
      modalSettings.setAttribute('aria-hidden','false');
    });

    function closeSettings(){
      saveRecipients();
      hide(modalSettings);
      modalSettings.setAttribute('aria-hidden','true');
    }
    btnCloseSettings.addEventListener('click',closeSettings);
    btnCloseAlt.addEventListener('click',closeSettings);

    function saveRecipients(){
      localStorage.setItem(STORAGE_KEYS.recipient1,rec1.value||'');
      localStorage.setItem(STORAGE_KEYS.recipient2,rec2.value||'');
    }
    function loadRecipients(){
      rec1.value=localStorage.getItem(STORAGE_KEYS.recipient1)||'';
      rec2.value=localStorage.getItem(STORAGE_KEYS.recipient2)||'';
    }

    function applyTheme(theme){
      if(theme === 'dark'){
        document.body.classList.add('dark');
      } else {
        document.body.classList.remove('dark');
      }
      localStorage.setItem(STORAGE_KEYS.theme, theme);
      if(themeSelect) themeSelect.value = theme;
    }

    const storedTheme = localStorage.getItem(STORAGE_KEYS.theme) || 'light';
    applyTheme(storedTheme);

    if(themeSelect){
      themeSelect.addEventListener('change', () => {
        applyTheme(themeSelect.value);
      });
    }

    // LÅSNING AF MAIL-ADRESSER ------------------------------------------------

    function getLockState(){
      return localStorage.getItem(STORAGE_KEYS.lockState) || 'unlocked';
    }
    function setLockState(state){
      localStorage.setItem(STORAGE_KEYS.lockState, state);
    }
    function getStoredPin(){
      return localStorage.getItem(STORAGE_KEYS.lockPin) || '';
    }
    function setStoredPin(pin){
      localStorage.setItem(STORAGE_KEYS.lockPin, pin);
    }

    function updateLockButtonLabel() {
      const state = getLockState();
      if (state === 'locked') {
        btnToggleLock.textContent = 'Låst';
        btnToggleLock.classList.add('lock-locked');
        btnToggleLock.classList.remove('lock-unlocked');
      } else {
        btnToggleLock.textContent = 'Oplåst';
        btnToggleLock.classList.add('lock-unlocked');
        btnToggleLock.classList.remove('lock-locked');
      }
    }

    function applyLockStateUI(){
      const state = getLockState();
      if (state === 'locked') {
        rec1.disabled = true;
        rec2.disabled = true;
        lockStatus.textContent = 'Modtagere er låst. Kun med PIN kan de ændres.';
      } else {
        rec1.disabled = false;
        rec2.disabled = false;
        lockStatus.textContent = 'Modtagere er ulåst. De kan ændres.';
      }
      updateLockButtonLabel();
    }

    function promptForPin(message){
      let pin = prompt(message);
      if (pin === null) return null;
      pin = pin.trim();
      if (!/^\d{4}$/.test(pin)) {
        alert('PIN skal være 4 cifre.');
        return null;
      }
      return pin;
    }

    btnToggleLock.addEventListener('click', () => {
      const currentState = getLockState();
      const currentPin = getStoredPin();

      if (currentState === 'unlocked') {
        let pin = currentPin;
        if (!pin) {
          pin = promptForPin('Indtast ny 4-cifret PIN til at låse modtagere:');
          if (!pin) return;
          setStoredPin(pin);
          alert('PIN er sat. Brug den samme PIN for at låse op.');
        } else {
          const entered = promptForPin('Indtast PIN for at låse modtagere:');
          if (!entered) return;
          if (entered !== currentPin) {
            alert('Forkert PIN. Modtagere forbliver ulåst.');
            return;
          }
        }
        setLockState('locked');
        applyLockStateUI();
      } else {
        if (!currentPin) {
          alert('Ingen PIN er sat. Kan ikke låse op på sikker vis.');
          return;
        }
        const entered = promptForPin('Indtast PIN for at låse modtagere op:');
        if (!entered) return;
        if (entered !== currentPin) {
          alert('Forkert PIN. Modtagere forbliver låst.');
          return;
        }
        setLockState('unlocked');
        applyLockStateUI();
      }
    });

    // START / TILBAGE ---------------------------------------------------------

    btnStart.addEventListener('click',()=>{
      hide(workHelp);
      hide(workRequired);

      if(!homeWorkNr.value||homeWorkNr.value.trim()===''){
        show(workRequired);
        return;
      }
      if(!/^\d{5}$/.test(homeWorkNr.value||'')){
        show(workHelp);
        return;
      }

      renderChecklist(homeChecklistSelect.value);
      hide(pageHome);
      show(pageChecklist);
      adjustProgressTop();
      updateProgressBar();
      window.scrollTo(0,0);
    });

    btnBack.addEventListener('click',()=>{
      hide(pageChecklist);
      show(pageHome);
      hide(progressWrapper);
      progressFill.style.width='0%';
      progressText.textContent='0% · 0/0';
      hide(progressHint);
      hide(minusToggleBar);
      currentChecklistName=null;
      minusModeActive = false;
      btnMinusMode.classList.remove('active');
      minusHintText.textContent = 'Aktiver for at markere én opgave som minus (kræver kommentar).';
      if(progressTrack) progressTrack.setAttribute('aria-valuenow','0');
      window.scrollTo(0,0);
    });

    homeWorkNr.addEventListener('input',()=>{
      hide(workHelp);
      hide(workRequired);
      homeWorkNr.value=(homeWorkNr.value||'').replace(/[^\d]/g,'').slice(0,5);
    });

    function setTodayDate(){
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      homeDate.value = `${year}-${month}-${day}`;
    }

    (function init(){
      try{
        setTodayDate();

        homeChecklistSelect.innerHTML='';
        Object.keys(checklists).forEach(k=>{
          const o=document.createElement('option');
          o.value=k;
          o.textContent=k;
          homeChecklistSelect.appendChild(o);
        });

        loadRecipients();
        applyLockStateUI();
        adjustProgressTop();
        hide(progressWrapper);
        hide(workHelp);
        hide(workRequired);
        hide(minusToggleBar);
      }catch(e){
        console.error('Kritisk fejl under initialisering:',e);
      }
    })();
  </script>
</body>
</html>
